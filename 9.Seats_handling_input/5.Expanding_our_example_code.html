<!DOCTYPE html>
<html lang="zh-Hans" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>扩展我们的示例代码 | The Wayland Protocol Zh</title>
    <meta name="description" content="A VitePress site">
    <link rel="preload stylesheet" href="/assets/style.ff2d27ee.css" as="style">
    <link rel="modulepreload" href="/assets/app.9965651d.js">
    <link rel="modulepreload" href="/assets/9.Seats_handling_input_5.Expanding_our_example_code.md.d2d3d7f2.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-93a960b4><!--[--><!--]--><!--[--><span tabindex="-1" data-v-151f2593></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-151f2593> Skip to content </a><!--]--><!----><header class="VPNav" data-v-93a960b4 data-v-790c334c><div class="VPNavBar has-sidebar" data-v-790c334c data-v-eda5fd6f><div class="container" data-v-eda5fd6f><div class="title" data-v-eda5fd6f><div class="VPNavBarTitle has-sidebar" data-v-eda5fd6f data-v-6d2fb2d9><a class="title" href="/" data-v-6d2fb2d9><!--[--><!--]--><!----><!--[-->The Wayland Protocol Zh<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-eda5fd6f><div class="curtain" data-v-eda5fd6f></div><!--[--><!--]--><!----><!----><!----><div class="VPNavBarAppearance appearance" data-v-eda5fd6f data-v-da3f667a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-da3f667a data-v-0d529b6d data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-0d529b6d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-0d529b6d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-eda5fd6f data-v-2ab2a029 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/axionl/the_wayland_protocol_zh_CN" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-eda5fd6f data-v-f38c483a data-v-96001b6b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-96001b6b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-96001b6b><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-96001b6b><div class="VPMenu" data-v-96001b6b data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-f38c483a><div class="item appearance" data-v-f38c483a><p class="label" data-v-f38c483a>Appearance</p><div class="appearance-action" data-v-f38c483a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-f38c483a data-v-0d529b6d data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-0d529b6d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-0d529b6d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-f38c483a><div class="item social-links" data-v-f38c483a><div class="VPSocialLinks social-links-list" data-v-f38c483a data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/axionl/the_wayland_protocol_zh_CN" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-eda5fd6f data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-93a960b4 data-v-2817d72e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2817d72e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-2817d72e><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-2817d72e>Menu</span></button><a class="top-link" href="#" data-v-2817d72e>Return to top</a></div><aside class="VPSidebar" data-v-93a960b4 data-v-941101de><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-941101de><span class="visually-hidden" id="sidebar-aria-label" data-v-941101de> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-941101de><section class="VPSidebarGroup" data-v-941101de data-v-c88a18d6><div class="title" data-v-c88a18d6><h2 class="title-text" data-v-c88a18d6>1. 绪论</h2><div class="action" data-v-c88a18d6><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-c88a18d6><!--[--><!--[--><a class="VPLink link link" href="/1-introduction/" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>引言</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/1-introduction/high-level-design.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>Wayland 上层设计</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/1-introduction/goals.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>学习目标</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/1-introduction/package.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>wayland packages</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-941101de><section class="VPSidebarGroup" data-v-941101de data-v-c88a18d6><div class="title" data-v-c88a18d6><h2 class="title-text" data-v-c88a18d6>2. 协议设计</h2><div class="action" data-v-c88a18d6><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-c88a18d6><!--[--><!--[--><a class="VPLink link link" href="/2-protocol-design/" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>引言</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/2-protocol-design/wire-protocol.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>基础协议</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/2-protocol-design/interfaces-reqs-events.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>接口与事件请求</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/2-protocol-design/high-level.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>上层协议</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/2-protocol-design/design-patterns.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>协议设计规范</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-941101de><section class="VPSidebarGroup" data-v-941101de data-v-c88a18d6><div class="title" data-v-c88a18d6><h2 class="title-text" data-v-c88a18d6>3. libwayland</h2><div class="action" data-v-c88a18d6><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-c88a18d6><!--[--><!--[--><a class="VPLink link link" href="/3-libwayland/" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>引言</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/3-libwayland/util.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>wayland-util 原语</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/3-libwayland/wayland-scanner.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>wayland-scanner</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/3-libwayland/proxies.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>资源与代理</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/3-libwayland/interfaces.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>接口与监听</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-941101de><section class="VPSidebarGroup" data-v-941101de data-v-c88a18d6><div class="title" data-v-c88a18d6><h2 class="title-text" data-v-c88a18d6>4. wayland display</h2><div class="action" data-v-c88a18d6><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-c88a18d6><!--[--><!--[--><a class="VPLink link link" href="/4-wayland-display/" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>引言</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/4-wayland-display/creation.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>display 创建</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/4-wayland-display/event-loop.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>加入事件循环</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-941101de><section class="VPSidebarGroup" data-v-941101de data-v-c88a18d6><div class="title" data-v-c88a18d6><h2 class="title-text" data-v-c88a18d6>5. 全局变量与注册</h2><div class="action" data-v-c88a18d6><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-c88a18d6><!--[--><!--[--><a class="VPLink link link" href="/5-registry/" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>引言</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/5-registry/binding.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>绑定全局变量</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/5-registry/server-side.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>注册全局变量</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-941101de><section class="VPSidebarGroup" data-v-941101de data-v-c88a18d6><div class="title" data-v-c88a18d6><h2 class="title-text" data-v-c88a18d6>6. 缓冲区与表面</h2><div class="action" data-v-c88a18d6><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-c88a18d6><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-c88a18d6><!--[--><!--[--><a class="VPLink link link" href="/6-surfaces/" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>引言</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/6-surfaces/compositor.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>wl_compositor 使用</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/6-surfaces/shared-memory.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>共享内存 buffer</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/6-surfaces/dmabuf.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>Linux dmabuf</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/6-surfaces/roles.html" style="padding-left:0px;" tabindex="-1" data-v-4a1a7e6c data-v-3c355974><!--[--><span class="link-text" data-v-4a1a7e6c>Surface roles</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-93a960b4 data-v-0bd490fb><div class="VPDoc has-sidebar has-aside" data-v-0bd490fb data-v-c5936a1e><div class="container" data-v-c5936a1e><div class="aside" data-v-c5936a1e><div class="aside-curtain" data-v-c5936a1e></div><div class="aside-container" data-v-c5936a1e><div class="aside-content" data-v-c5936a1e><div class="VPDocAside" data-v-c5936a1e data-v-cdc66372><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-cdc66372 data-v-0627715d><div class="content" data-v-0627715d><div class="outline-marker" data-v-0627715d></div><div class="outline-title" data-v-0627715d>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-0627715d><span class="visually-hidden" id="doc-outline-aria-label" data-v-0627715d> Table of Contents for current page </span><ul class="root" data-v-0627715d data-v-1188541a><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cdc66372></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c5936a1e><div class="content-container" data-v-c5936a1e><!--[--><!--]--><main class="main" data-v-c5936a1e><div style="position:relative;" class="vp-doc _9_Seats_handling_input_5_Expanding_our_example_code" data-v-c5936a1e><div><h1 id="扩展我们的示例代码" tabindex="-1">扩展我们的示例代码 <a class="header-anchor" href="#扩展我们的示例代码" aria-hidden="true">#</a></h1><p>在前面几章中，我们建立了一个简单的客户端，它可以在显示器上展示其表面。让我们把这个代码扩展一下，建立一个可以接收输入事件的客户端。为了简单起见，我们仅仅将输入事件记录到 stderr。</p><p>这需要更多的代码，而不仅仅是将到目前为止的工作绑在一起。我们需要做的第一件事就是设置座位。</p><h2 id="设置座位" tabindex="-1">设置座位 <a class="header-anchor" href="#设置座位" aria-hidden="true">#</a></h2><p>我们首先需要的是一个对座位的引用。我们将把它添加到我们的 <code>client_state</code> 结构体中，并添加键盘、指针和触摸对象供后期使用。</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">        struct wl_shm *wl_shm;</span></span>
<span class="line"><span style="color:#A6ACCD;">        struct wl_compositor *wl_compositor;</span></span>
<span class="line"><span style="color:#A6ACCD;">        struct xdg_wm_base *xdg_wm_base;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       struct wl_seat *wl_seat;</span></span>
<span class="line"><span style="color:#A6ACCD;">        /* Objects */</span></span>
<span class="line"><span style="color:#A6ACCD;">        struct wl_surface *wl_surface;</span></span>
<span class="line"><span style="color:#A6ACCD;">        struct xdg_surface *xdg_surface;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       struct wl_keyboard *wl_keyboard;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       struct wl_pointer *wl_pointer;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       struct wl_touch *wl_touch;</span></span>
<span class="line"><span style="color:#A6ACCD;">        /* State */</span></span>
<span class="line"><span style="color:#A6ACCD;">        float offset;</span></span>
<span class="line"><span style="color:#A6ACCD;">        uint32_t last_frame;</span></span>
<span class="line"><span style="color:#A6ACCD;">        int width, height;</span></span>
<span class="line"></span></code></pre></div><p>我们还需要更新 <code>registry_global</code>，为该座位注册一个监听器。</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">                                wl_registry, name, &amp;xdg_wm_base_interface, 1);</span></span>
<span class="line"><span style="color:#A6ACCD;">                xdg_wm_base_add_listener(state-&gt;xdg_wm_base,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                &amp;xdg_wm_base_listener, state);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       } else if (strcmp(interface, wl_seat_interface.name) == 0) {</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               state-&gt;wl_seat = wl_registry_bind(</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">                               wl_registry, name, &amp;wl_seat_interface, 7);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               wl_seat_add_listener(state-&gt;wl_seat,</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">                               &amp;wl_seat_listener, state);</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;"> }</span></span>
<span class="line"></span></code></pre></div><p>请注意，我们绑定的是最新版本的座位接口，即第 7 版。让我们把监听器也加上：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_seat_capabilities</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_seat </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_seat</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">capabilities</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       /* TODO */</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_seat_name</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_seat </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_seat</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">char</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">name</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">seat name: %s</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_seat_listener wl_seat_listener </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       .capabilities </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_seat_capabilities</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .name </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_seat_name</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>如果你现在编译 <code>(cc -o client client.c xdg-shell-protocol.c)</code> 并运行这个，你的座位名字就应该被打印到 stderr。</p><h2 id="接入指针事件" tabindex="-1">接入指针事件 <a class="header-anchor" href="#接入指针事件" aria-hidden="true">#</a></h2><p>让我们来谈谈光标指针事件。如果你还记得，前面我们提到来自 Wayland 服务端的指针事件会被累积为一个单一逻辑事件。因此，我们需要定义一个结构体来存储这些事件。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> pointer_event_mask </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       POINTER_EVENT_ENTER </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       POINTER_EVENT_LEAVE </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       POINTER_EVENT_MOTION </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       POINTER_EVENT_BUTTON </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       POINTER_EVENT_AXIS </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       POINTER_EVENT_AXIS_SOURCE </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       POINTER_EVENT_AXIS_STOP </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">6</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       POINTER_EVENT_AXIS_DISCRETE </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> pointer_event </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> event_mask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#F07178;"> surface_x</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> surface_y</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> button</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> state</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> time</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> serial</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#C792EA;">bool</span><span style="color:#F07178;"> valid</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#F07178;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#C792EA;">int32_t</span><span style="color:#F07178;"> discrete</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">axes</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> axis_source</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>这里我们使用一个位掩码来识别我们接受到的单个指针帧中的事件，并将每个事件的相关信息存储到各自的字段中。让我们也将此添加到我们的状态结构体中：</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">        /* State */</span></span>
<span class="line"><span style="color:#A6ACCD;">        float offset;</span></span>
<span class="line"><span style="color:#A6ACCD;">        uint32_t last_frame;</span></span>
<span class="line"><span style="color:#A6ACCD;">        int width, height;</span></span>
<span class="line"><span style="color:#A6ACCD;">        bool closed;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       struct pointer_event pointer_event;</span></span>
<span class="line"><span style="color:#A6ACCD;"> };</span></span>
<span class="line"></span></code></pre></div><p>然后我们需要更新我们的 <code>wl_seat_capabilities</code>，为有光标指针输入功能的座位指定指针对象。</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;"> static void</span></span>
<span class="line"><span style="color:#A6ACCD;"> wl_seat_capabilities(void *data, struct wl_seat *wl_seat, uint32_t capabilities)</span></span>
<span class="line"><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">        struct client_state *state = data;</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#F07178;">       /* TODO */</span></span>
<span class="line"><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       bool have_pointer = capabilities &amp; WL_SEAT_CAPABILITY_POINTER;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       if (have_pointer &amp;&amp; state-&gt;wl_pointer == NULL) {</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               state-&gt;wl_pointer = wl_seat_get_pointer(state-&gt;wl_seat);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               wl_pointer_add_listener(state-&gt;wl_pointer,</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">                               &amp;wl_pointer_listener, state);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       } else if (!have_pointer &amp;&amp; state-&gt;wl_pointer != NULL) {</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               wl_pointer_release(state-&gt;wl_pointer);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               state-&gt;wl_pointer = NULL;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><p>这里值得解释一下。回想一下，功能 <code>capabilities</code> 是此座位支持的设备类型的位掩码，即如果支持，则进行位与运算 (&amp;) 将产生非零值。然后，如果我们有一个光标指针，并且还没有配置它，我们就访问第一个分支 (第一个 if)，使用 <code>wl_seat_get_pointer</code> 来分配一个光标指针的引用并将它存储在我们的状态 (state) 中。如果座位不支持光标指针，但我们却已经配置了一个，那么需要使用 <code>wl_pointer_release</code> 来释放这个引用。请记住，一个座位的 <code>capabilities</code> 可能在运行时改变，例如，当用户重新插拔他们的鼠标时座位所拥有的功能就会改变。</p><p>我们还为指针配置了一个监听器。让我们将它也添加到结构体中：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer_listener wl_pointer_listener </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       .enter </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_pointer_enter</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .leave </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_pointer_leave</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .motion </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_pointer_motion</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .button </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_pointer_button</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .axis </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_pointer_axis</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .frame </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_pointer_frame</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .axis_source </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_pointer_axis_source</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .axis_stop </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_pointer_axis_stop</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .axis_discrete </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_pointer_axis_discrete</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>指针拥有许多事件，让我们来看看它们。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_pointer_enter</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_pointer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">serial</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_surface </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">surface</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">surface_x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">surface_y</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> POINTER_EVENT_ENTER</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">serial</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> serial</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">surface_x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> surface_x</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">surface_y</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> surface_y</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_pointer_leave</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_pointer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">serial</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_surface </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">surface</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">serial</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> serial</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> POINTER_EVENT_LEAVE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>进入 &quot;enter&quot; 和离开 &quot;leave&quot; 事件是非常直截了当的，它们为其余的执行工作提供了舞台。我们更新事件掩码以包括适当的事件，然后用我们提供的数据填充进去。运动 &quot;motion&quot; 和按钮 &quot;button&quot; 事件也是十分类似的：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_pointer_motion</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_pointer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">time</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">surface_x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">surface_y</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> POINTER_EVENT_MOTION</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">time</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> time</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">surface_x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> surface_x</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">surface_y</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> surface_y</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_pointer_button</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_pointer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">serial</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">time</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">button</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">state</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> POINTER_EVENT_BUTTON</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">time</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> time</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">serial</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> serial</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">button</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> button</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">state</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> state</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>轴事件有点复杂，因为存在两个方向的轴：水平和垂直。因此，我们的 <code>pointer_event</code> 结构体也包含具有两组轴事件的数组。我们处理这些的代码最终如下：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_pointer_axis</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_pointer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">time</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> POINTER_EVENT_AXIS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">time</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> time</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">axes</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">axis</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">valid</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">axes</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">axis</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_pointer_axis_source</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_pointer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">axis_source</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> POINTER_EVENT_AXIS_SOURCE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">axis_source</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> axis_source</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_pointer_axis_stop</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_pointer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">time</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">time</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> time</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> POINTER_EVENT_AXIS_STOP</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">axes</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">axis</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">valid</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_pointer_axis_discrete</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_pointer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">discrete</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> POINTER_EVENT_AXIS_DISCRETE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">axes</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">axis</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">valid</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">axes</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">axis</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">discrete</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> discrete</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>除了更新受到影响的轴这一主要变化之外，其余部分也同样非常直截了当。请注意 &quot;valid&quot; 布尔值的使用：我们有可能受到更新了一个轴但没更新另一个的指针帧 (pointer frame)，所以我们使用 &quot;valid&quot; 值来确定该帧事件中哪些轴被有效更新。</p><p>说到这里，现在是该集中注意力的地方了：我们的 &quot;frame&quot; 句柄。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_pointer_frame</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_pointer </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_pointer</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> pointer_event </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">event </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pointer_event</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pointer frame @ %d: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> POINTER_EVENT_ENTER</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">entered %f, %f </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_x</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_y</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> POINTER_EVENT_LEAVE</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">leave</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> POINTER_EVENT_MOTION</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">motion %f, %f </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_x</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_y</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> POINTER_EVENT_BUTTON</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#C792EA;">char</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">state</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> WL_POINTER_BUTTON_STATE_RELEASED </span><span style="color:#89DDFF;">?</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">released</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pressed</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">button %d %s </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">button</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> state</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> axis_events </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> POINTER_EVENT_AXIS</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> POINTER_EVENT_AXIS_SOURCE</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> POINTER_EVENT_AXIS_STOP</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> POINTER_EVENT_AXIS_DISCRETE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">char</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">axis_name</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">WL_POINTER_AXIS_VERTICAL_SCROLL</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">vertical</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">WL_POINTER_AXIS_HORIZONTAL_SCROLL</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">horizontal</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">char</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">axis_source</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">WL_POINTER_AXIS_SOURCE_WHEEL</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">wheel</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">WL_POINTER_AXIS_SOURCE_FINGER</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">finger</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">WL_POINTER_AXIS_SOURCE_CONTINUOUS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">continuous</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">WL_POINTER_AXIS_SOURCE_WHEEL_TILT</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">wheel tilt</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> axis_events</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">size_t</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">++</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">axes</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">valid</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#89DDFF;font-style:italic;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">%s axis </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">axis_name</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">]);</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> POINTER_EVENT_AXIS</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">value %f </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#F07178;">                                                       </span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">axes</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> POINTER_EVENT_AXIS_DISCRETE</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">discrete %d </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                                               </span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">axes</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">discrete</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> POINTER_EVENT_AXIS_SOURCE</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">via %s </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                                               </span><span style="color:#A6ACCD;">axis_source</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">axis_source</span><span style="color:#89DDFF;">]);</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">event</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> POINTER_EVENT_AXIS_STOP</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">(stopped) </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">memset</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">event</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(*</span><span style="color:#F07178;">event</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>毋庸置疑，这是最长的一串代码了。但愿它不会令人感到困惑。我们在这里所做的就是把这一帧期间累积的状态漂亮地打印到 stderr 上。如果你现在再编译并运行这个程序，你应该可以在窗口上晃动你的鼠标，并看到输入事件被打印出来!</p><h2 id="接入键盘事件" tabindex="-1">接入键盘事件 <a class="header-anchor" href="#接入键盘事件" aria-hidden="true">#</a></h2><p>让我们用一些字段更新我们的 <code>client_state</code> 结构，以存储 XKB 的状态。</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">@@</span><span style="color:#A6ACCD;"> -105,6 +107,9 </span><span style="color:#89DDFF;">@@</span><span style="color:#A6ACCD;"> struct client_state {</span></span>
<span class="line"><span style="color:#A6ACCD;">        int width, height;</span></span>
<span class="line"><span style="color:#A6ACCD;">        bool closed;</span></span>
<span class="line"><span style="color:#A6ACCD;">        struct pointer_event pointer_event;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       struct xkb_state *xkb_state;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       struct xkb_context *xkb_context;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       struct xkb_keymap *xkb_keymap;</span></span>
<span class="line"><span style="color:#A6ACCD;">};</span></span>
<span class="line"></span></code></pre></div><p>我们需要 <code>xkbcommon</code> 头文件来定义这些。通常当我们这样做的时候，我将会把 <code>assert.h</code> 也拉进来。</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">@@</span><span style="color:#A6ACCD;"> -1,4 +1,5 </span><span style="color:#89DDFF;">@@</span></span>
<span class="line"><span style="color:#A6ACCD;"> #define _POSIX_C_SOURCE 200112L</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">#include &lt;assert.h&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"> #include &lt;errno.h&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"> #include &lt;fcntl.h&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"> #include &lt;limits.h&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">@@</span><span style="color:#A6ACCD;"> -9,6 +10,7 </span><span style="color:#89DDFF;">@@</span></span>
<span class="line"><span style="color:#A6ACCD;"> #include &lt;time.h&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"> #include &lt;unistd.h&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"> #include &lt;wayland-client.h&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">#include &lt;xkbcommon/xkbcommon.h&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"> #include &quot;xdg-shell-client-protocol.h&quot;</span></span>
<span class="line"></span></code></pre></div><p>我们还需要在我们的主函数中初始化 <code>xkb_context</code>:</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">@@</span><span style="color:#A6ACCD;"> -603,6 +649,7 </span><span style="color:#89DDFF;">@@</span><span style="color:#A6ACCD;"> main(int argc, char *argv[])</span></span>
<span class="line"><span style="color:#A6ACCD;">        state.height = 480;</span></span>
<span class="line"><span style="color:#A6ACCD;">        state.wl_display = wl_display_connect(NULL);</span></span>
<span class="line"><span style="color:#A6ACCD;">        state.wl_registry = wl_display_get_registry(state.wl_display);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       state.xkb_context = xkb_context_new(XKB_CONTEXT_NO_FLAGS);</span></span>
<span class="line"><span style="color:#A6ACCD;">        wl_registry_add_listener(state.wl_registry, &amp;wl_registry_listener, &amp;state);</span></span>
<span class="line"><span style="color:#A6ACCD;">        wl_display_roundtrip(state.wl_display);</span></span>
<span class="line"></span></code></pre></div><p>下一步，让我们来更新我们座位的功能函数，把我们的键盘监听器也接入。</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">        } else if (!have_pointer &amp;&amp; state-&gt;wl_pointer != NULL) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                wl_pointer_release(state-&gt;wl_pointer);</span></span>
<span class="line"><span style="color:#A6ACCD;">                state-&gt;wl_pointer = NULL;</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       bool have_keyboard = capabilities &amp; WL_SEAT_CAPABILITY_KEYBOARD;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       if (have_keyboard &amp;&amp; state-&gt;wl_keyboard == NULL) {</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               state-&gt;wl_keyboard = wl_seat_get_keyboard(state-&gt;wl_seat);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               wl_keyboard_add_listener(state-&gt;wl_keyboard,</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">                               &amp;wl_keyboard_listener, state);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       } else if (!have_keyboard &amp;&amp; state-&gt;wl_keyboard != NULL) {</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               wl_keyboard_release(state-&gt;wl_keyboard);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               state-&gt;wl_keyboard = NULL;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       }</span></span>
<span class="line"><span style="color:#A6ACCD;"> }</span></span>
<span class="line"></span></code></pre></div><p>我们也要在这里定义我们使用的 <code>wl_keyboard_listener</code>。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_keyboard_listener wl_keyboard_listener </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       .keymap </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_keyboard_keymap</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .enter </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_keyboard_enter</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .leave </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_keyboard_leave</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .key </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_keyboard_key</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .modifiers </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_keyboard_modifiers</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .repeat_info </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_keyboard_repeat_info</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>现在开始有了一些变化，让我们从 keymap 开始：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_keyboard_keymap</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_keyboard </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_keyboard</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">format</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">fd</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">size</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">assert</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">format </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> WL_KEYBOARD_KEYMAP_FORMAT_XKB_V1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">char</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">map_shm </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">mmap</span><span style="color:#89DDFF;">(NULL,</span><span style="color:#F07178;"> size</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> PROT_READ</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> MAP_SHARED</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> fd</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">assert</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">map_shm </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> MAP_FAILED</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> xkb_keymap </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">xkb_keymap </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">xkb_keymap_new_from_string</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_context</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> map_shm</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                       XKB_KEYMAP_FORMAT_TEXT_V1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> XKB_KEYMAP_COMPILE_NO_FLAGS</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">munmap</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">map_shm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> size</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">close</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">fd</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> xkb_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">xkb_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">xkb_state_new</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">xkb_keymap</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">xkb_keymap_unref</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_keymap</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">xkb_state_unref</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_state</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_keymap</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> xkb_keymap</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_state</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> xkb_state</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>现在我们可以看到为什么我们需要添加 <code>assert.h</code>——我们在这里用断言来确保 keymap 的格式是我们所期望的。然后，我们用 mmap 将混成器发送给我们的文件描述符 fd 映射成一个 <code>char*</code> 指针，我们可以将其传入 <code>xkb_keymap_new_from_string</code>。不要忘记 <code>munmap</code> 并在之后关闭这个文件描述符，然后设置我们的 XKB 状态。还要注意的是，我们也用 &quot;*_unref&quot; 去掉了先前在调用此函数时所设置的一切 XKB keymap 或 state 引用，以防混成器在运行时改变 keymap<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_keyboard_enter</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_keyboard </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_keyboard</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">serial</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_surface </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">surface</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_array </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">keys</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">keyboard enter; keys pressed are:</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">wl_array_for_each</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> keys</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#C792EA;">char</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">buf</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">128</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#FFCB6B;">xkb_keysym_t</span><span style="color:#F07178;"> sym </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">xkb_state_key_get_one_sym</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_state</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">key </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">8</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">xkb_keysym_get_name</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">sym</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> buf</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#F07178;">buf</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sym: %-12s (%d), </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> buf</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> sym</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">xkb_state_key_get_utf8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_state</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                               </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">key </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">8</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> buf</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#F07178;">buf</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf8: &#39;%s&#39;</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> buf</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>当键盘 &quot;进入&quot; 我们的表面时，我们已经获得了键盘的输入焦点。混成器会将这之前所按键的队列转发出来，这里我们只是枚举它们并记录它们的 keysym 名称和 UTF-8 等效值。当按键被按下的时候，我们会做类似如下的事情：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_keyboard_key</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_keyboard </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_keyboard</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">serial</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">time</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">key</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">state</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">char</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">buf</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">128</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> keycode </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> key </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">8</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#FFCB6B;">xkb_keysym_t</span><span style="color:#F07178;"> sym </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">xkb_state_key_get_one_sym</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_state</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> keycode</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">xkb_keysym_get_name</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">sym</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> buf</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#F07178;">buf</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">char</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">action </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#F07178;">               state </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> WL_KEYBOARD_KEY_STATE_PRESSED </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">press</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">release</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">key %s: sym: %-12s (%d), </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> action</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> buf</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> sym</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">xkb_state_key_get_utf8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_state</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> keycode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                       buf</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#F07178;">buf</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">utf8: &#39;%s&#39;</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> buf</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>最后，我们增加了其余三个小事件的实现：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_keyboard_leave</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_keyboard </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_keyboard</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">serial</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_surface </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">surface</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">keyboard leave</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_keyboard_modifiers</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_keyboard </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_keyboard</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">serial</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">mods_depressed</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">mods_latched</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">mods_locked</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">group</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">xkb_state_update_mask</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">xkb_state</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">               mods_depressed</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> mods_latched</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> mods_locked</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> group</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_keyboard_repeat_info</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_keyboard </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_keyboard</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">rate</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">delay</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">       /* Left as an exercise for the reader */</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>对于修饰符，我们可以进一步解码，但大多数应用程序不需要这样做。我们只是在这里更新 XKB 的状态。至于处理按键重复，这对于你的应用来说有诸多限制。比如，你想重复输入文本吗，想重复键盘快捷键吗，这些重复的所需的时间如何与你的事件循环进行互动？这些问题的答案需要由你自己来决定。</p><p>如果你再次编译并运行，你应该能够开始在窗口中开始打字，并看到你的输入被打印到终端日志中。这值得欢呼！</p><h2 id="接入触摸事件" tabindex="-1">接入触摸事件 <a class="header-anchor" href="#接入触摸事件" aria-hidden="true">#</a></h2><p>最后，我们将新增设备的触摸功能支持。就和指针事件一样，触摸设备也存在一个 &quot;frame&quot; 帧事件。然而，由于有多个触摸点可能在一帧内被更新，所以它们可能变得更加复杂。我们将增加一些结构体和枚举类型来表示状态的累积。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> touch_event_mask </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       TOUCH_EVENT_DOWN </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       TOUCH_EVENT_UP </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       TOUCH_EVENT_MOTION </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       TOUCH_EVENT_CANCEL </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       TOUCH_EVENT_SHAPE </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       TOUCH_EVENT_ORIENTATION </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> touch_point </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">bool</span><span style="color:#F07178;"> valid</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">int32_t</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> event_mask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#F07178;"> surface_x</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> surface_y</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#F07178;"> major</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> minor</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#F07178;"> orientation</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> touch_event </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> event_mask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> time</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> serial</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_point </span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>请注意，我在这里选择了 10 个触摸点，假设大多数用户只会使用这么多手指。而对于较大的多用户触摸屏，你可能需要一个更高的上限。此外，有些触摸硬件同时支持的触摸点少于十个，仅有八个也是常见的，而支持触摸点数量更少的硬件在老旧设备中也十分常见。</p><p>我们把这个结构体添加到 <code>client_state</code>:</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">@@</span><span style="color:#A6ACCD;"> -110,6 +135,7 </span><span style="color:#89DDFF;">@@</span><span style="color:#A6ACCD;"> struct client_state {</span></span>
<span class="line"><span style="color:#A6ACCD;">        struct xkb_state *xkb_state;</span></span>
<span class="line"><span style="color:#A6ACCD;">        struct xkb_context *xkb_context;</span></span>
<span class="line"><span style="color:#A6ACCD;">        struct xkb_keymap *xkb_keymap;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       struct touch_event touch_event;</span></span>
<span class="line"><span style="color:#A6ACCD;"> };</span></span>
<span class="line"></span></code></pre></div><p>当触摸支持可用的时候，我们将更新座位的功能句柄，以介入一个监听器。</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">        } else if (!have_keyboard &amp;&amp; state-&gt;wl_keyboard != NULL) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                wl_keyboard_release(state-&gt;wl_keyboard);</span></span>
<span class="line"><span style="color:#A6ACCD;">                state-&gt;wl_keyboard = NULL;</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       bool have_touch = capabilities &amp; WL_SEAT_CAPABILITY_TOUCH;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       if (have_touch &amp;&amp; state-&gt;wl_touch == NULL) {</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               state-&gt;wl_touch = wl_seat_get_touch(state-&gt;wl_seat);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               wl_touch_add_listener(state-&gt;wl_touch,</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">                               &amp;wl_touch_listener, state);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       } else if (!have_touch &amp;&amp; state-&gt;wl_touch != NULL) {</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               wl_touch_release(state-&gt;wl_touch);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">               state-&gt;wl_touch = NULL;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">       }</span></span>
<span class="line"><span style="color:#A6ACCD;"> }</span></span>
<span class="line"></span></code></pre></div><p>我们对作为上触摸功能的出现和消失也做了同样处理，因此我们的代码在运行时设备热插拔处理方面都很健壮。不过，触摸设备热插拔的情况在实际中不太常见。</p><p>这里是其自身的监听器:</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_touch_listener wl_touch_listener </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       .down </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_touch_down</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .up </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_touch_up</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .motion </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_touch_motion</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .frame </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_touch_frame</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .cancel </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_touch_cancel</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .shape </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_touch_shape</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">       .orientation </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> wl_touch_orientation</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>为了解决多点触摸问题，我们需要写一个小的辅助函数:</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> touch_point </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#82AAFF;">get_touch_point</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">client_state</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">+{</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_event </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">touch </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">touch_event</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">size_t</span><span style="color:#F07178;"> nmemb </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_point</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> invalid </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">size_t</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> nmemb</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">++</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">                       </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">               </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">invalid </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">valid</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">                       invalid </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> i</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">               </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">invalid </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">invalid</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">valid</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">invalid</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">invalid</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#89DDFF;">+}</span></span>
<span class="line"></span></code></pre></div><p>这个函数的基本目的是从我们添加到 <code>touch_event</code> 结构体的数组中，根据我们要接收事件的触摸点 ID，挑选一个触摸点。如果我们找到了该 ID 的现有触摸点，我们就将其返回。如果没有，则会返回第一个可用的触摸点。如果我们都找完了还没有，就会返回 <code>NULL</code>。</p><p>现在我们可以利用这点来实现我们的第一个功能：触摸。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_touch_down</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_touch </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_touch</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">serial</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">time</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_surface </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">surface</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">y</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_point </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">get_touch_point</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">client_state</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> TOUCH_EVENT_UP</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">x</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_y</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">y</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">touch_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">time</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> time</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">touch_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">serial</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> serial</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>和指针事件一样，我们也是简单地将这个状态累积起来，以便后续使用。我们还不知道这个事件是否代表一个完整的触摸帧。让我们为触摸添加一些类似的东西：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_touch_up</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_touch </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_touch</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">serial</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">time</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_point </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">get_touch_point</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">client_state</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> TOUCH_EVENT_UP</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>以及运动：</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_touch_motion</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_touch </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_touch</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">time</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">y</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_point </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">get_touch_point</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">client_state</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> TOUCH_EVENT_MOTION</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> x</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_y</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> y</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">touch_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">time</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> time</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>触摸事件的取消与之前有所不同，因为它一次性 “取消” 了所有活动的触摸点。我们只需要将其存储在 <code>touch_event</code> 的顶层事件掩码中。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_touch_cancel</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_touch </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_touch</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">touch_event</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> TOUCH_EVENT_CANCEL</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>然而，形状和方向事件类似于向上、向下和移动，因为它们告诉我们一个特定触摸点的尺寸。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_touch_shape</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_touch </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_touch</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">major</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">minor</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_point </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">get_touch_point</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">client_state</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> TOUCH_EVENT_SHAPE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">major</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> major</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">minor</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> minor</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_touch_orientation</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_touch </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_touch</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">               </span><span style="color:#C792EA;">int32_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">id</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wl_fixed_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">orientation</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_point </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">get_touch_point</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">client_state</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> TOUCH_EVENT_ORIENTATION</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">orientation</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> orientation</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>最后，在收到一个帧事件时，我们可以将所有这些累积的状态解释为一个单一的输入事件，就像我们的光标指针代码一样。</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span></span>
<span class="line"><span style="color:#82AAFF;">wl_touch_frame</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> wl_touch </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">wl_touch</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> client_state </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">client_state </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_event </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">touch </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">client_state</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">touch_event</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">size_t</span><span style="color:#F07178;"> nmemb </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_point</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">touch event @ %d:</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">time</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">size_t</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> nmemb</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">++</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> touch_point </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">point </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">valid</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#89DDFF;font-style:italic;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">point %d: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">touch</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">points</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> TOUCH_EVENT_DOWN</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">down %f,%f </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                                       </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_x</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">                                       </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_y</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> TOUCH_EVENT_UP</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">up </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> TOUCH_EVENT_MOTION</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">motion %f,%f </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                                       </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_x</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">                                       </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">surface_y</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> TOUCH_EVENT_SHAPE</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">shape %fx%f </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                                       </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">major</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">                                       </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">minor</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">event_mask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> TOUCH_EVENT_ORIENTATION</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                       </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">orientation %f </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                                       </span><span style="color:#82AAFF;">wl_fixed_to_double</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">orientation</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#A6ACCD;">point</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">valid</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"><span style="color:#F07178;">               </span><span style="color:#82AAFF;">fprintf</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stderr</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>编译并再次运行这个程序，你就可以看到当你与触摸设备交互时，触摸事件被答应到 stderr （假设你现在有支持触摸的设备）。现在我们的客户端终于了实现输入的支持！</p><h2 id="接下来该做什么" tabindex="-1">接下来该做什么？ <a class="header-anchor" href="#接下来该做什么" aria-hidden="true">#</a></h2><p>有很多不同种类的输入设备，因此扩展我们的代码以支持这些设备是一项相当庞大的工作——仅在本章中我们的代码量就增加了 2.5 倍。不过收获应该也是相当大的，因为你现在已经熟悉了足够多的 Wayland 概念（和代码），由此你可以实现多种多样的客户端了。</p><p>这之后还有更多的东西要学——在最后几章，我们将介绍弹出窗口、上下文菜单、交互式窗口的移动和大小调整、剪贴板和拖放支持，以及后来的一些有趣的扩展协议，以支持更多小众的使用场景。我强烈建议你在构建自己的客户端之前先读到第 10.1 章，因为它涵盖诸如根据混成器的要求调整窗口大小等内容。</p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>这种情况在实践中确实发生了！ <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-c5936a1e data-v-e033cd21><div class="edit-info" data-v-e033cd21><div class="edit-link" data-v-e033cd21><a class="VPLink link edit-link-button" href="https://github.com/axionl/the_wayland_protocol_zh_CN/edit/main/docs/9.Seats_handling_input/5.Expanding_our_example_code.md" target="_blank" rel="noreferrer" data-v-e033cd21 data-v-3c355974><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" data-v-e033cd21><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> Edit this page<!--]--><!----></a></div><div class="last-updated" data-v-e033cd21><p class="VPLastUpdated" data-v-e033cd21 data-v-355aa5ef>Last updated: <time datetime="2023-01-16T10:02:42.000Z" data-v-355aa5ef></time></p></div></div><div class="prev-next" data-v-e033cd21><div class="pager" data-v-e033cd21><!----></div><div class="pager" data-v-e033cd21><a class="pager-link next" href="/1-introduction/" data-v-e033cd21><span class="desc" data-v-e033cd21>Next page</span><span class="title" data-v-e033cd21>引言</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"1-introduction_goals.md\":\"a4a836aa\",\"1-introduction_index.md\":\"0c5b3c85\",\"1-introduction_package.md\":\"016fe09d\",\"10.xdg_shell_in_depth_1.configuration_and_lifecycle.md\":\"25b9b6fe\",\"1-introduction_high-level-design.md\":\"d8b62aa8\",\"5-registry_index.md\":\"31e9725f\",\"10.xdg_shell_in_depth_2.popups.md\":\"578b61e1\",\"10.xdg_shell_in_depth_3.interactive_move_and_resize.md\":\"38eadd5d\",\"10.xdg_shell_in_depth_4.pointers.md\":\"73dd8066\",\"10.xdg_shell_in_depth_index.md\":\"69adf2c6\",\"2-protocol-design_design-patterns.md\":\"7c3b8e20\",\"2-protocol-design_high-level.md\":\"21895da0\",\"2-protocol-design_index.md\":\"3a431053\",\"2-protocol-design_interfaces-reqs-events.md\":\"4a8aa981\",\"2-protocol-design_wire-protocol.md\":\"cb1ffe29\",\"3-libwayland_index.md\":\"f2d24dec\",\"3-libwayland_interfaces.md\":\"3cf90139\",\"3-libwayland_util.md\":\"dc355ff5\",\"3-libwayland_wayland-scanner.md\":\"31050c99\",\"5-registry_binding.md\":\"34dbdbc4\",\"6-surfaces_compositor.md\":\"80d33213\",\"3-libwayland_proxies.md\":\"360d3819\",\"6-surfaces_dmabuf.md\":\"57586cd3\",\"6-surfaces_index.md\":\"bc84b104\",\"6-surfaces_shared-memory.md\":\"39c1ba46\",\"7.xdg_shell_basics_1.xdg_surfaces.md\":\"525db7f5\",\"5-registry_server-side.md\":\"5c8845ee\",\"4-wayland-display_creation.md\":\"178b1849\",\"4-wayland-display_event-loop.md\":\"86e52745\",\"4-wayland-display_index.md\":\"36c05483\",\"6-surfaces_roles.md\":\"9ffb267f\",\"7.xdg_shell_basics_3.extended_example_code.md\":\"e82ed863\",\"7.xdg_shell_basics_2.application_windows.md\":\"897fe6bd\",\"8.surfaces_in_depth_3.damaging_surfaces.md\":\"c1de0474\",\"8.surfaces_in_depth_4.surface_regions.md\":\"6da937ef\",\"8.surfaces_in_depth_6.high_density_surfaces.md\":\"0f043607\",\"8.surfaces_in_depth_index.md\":\"dfeb7f1b\",\"9.seats_handling_input_1.pointer_input.md\":\"e05f7c90\",\"9.seats_handling_input_2.xkb_briefly.md\":\"640c1ed3\",\"9.seats_handling_input_3.keyboard_input.md\":\"6026b05b\",\"9.seats_handling_input_4.touch_input.md\":\"f1c05f3a\",\"9.seats_handling_input_5.expanding_our_example_code.md\":\"d2d3d7f2\",\"9.seats_handling_input_index.md\":\"0ac98d93\",\"index.md\":\"6f611058\",\"8.surfaces_in_depth_5.subsurfaces.md\":\"35b47840\",\"7.xdg_shell_basics_index.md\":\"7bfd3ab4\",\"8.surfaces_in_depth_1.surface_lifecycle.md\":\"5c61c3ce\",\"8.surfaces_in_depth_2.frame_callbacks.md\":\"b8e63220\"}")</script>
    <script type="module" async src="/assets/app.9965651d.js"></script>
    
  </body>
</html>